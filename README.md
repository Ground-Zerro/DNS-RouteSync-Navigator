## DNS-RouteSync-Navigator


**Что делает:** Перенаправление трафика к указанным в фильтре доменам через VPN для младших моделей роутеров Keenetic без USB.


**Как работает:**
- Принимает DNS запросы от клиентов, разрешает их IP-адрес используя вышестоящий DNS сервер.
- Проверяет обрабатываемое DNS имя на соответствие фильтру указанных пользователем доменов.
- При обнаружении совпадения DNS имени с фильтром, посредством SSH добавляет на роутере статический маршрут для перенаправления трафика к IP-адресу домена через указанное пользователем VPN соединение.
- Фильтрация происходит по полному либо частичному соответствию вышестоящего домена. Например если в фильтре указано "ru" то для всех доменов RU зоны будут добавляться статические маршруты, или если в фильтре указанно - "mail.ru" то маршруты будут добавляться для него и всех остальных доменов заканчивающихся на ".mail.ru".


**Зависимости:** Для работы DNS-RouteSync-Navigator необходимо наличие следующих библиотек Python:
- configparser, dnslib, asyncssh, cachetools

*Не забудьте установить их перед запуском:*
```
pip3 install -r requirements.txt
```

**Использование:**

Добавьте нового пользователя в роутере и разрешите ему досутп по SSH.

Настройте в роутере любое, удобное вам, VPN подключение и дайте ему более-менее осмысленное название.

Узнайте "id" этого VPN подключения, для этого:
- зайдите и авторизируйтесь в админке роутера (обычно - 192.168.1.1),
- добавьте букву "а" после адреса роутера (было: "http://192.168.1.1/dashboard", стало: "http://192.168.1.1/a"),
- в поле "Command" наберите "show interface" и нажмите Enter,
- найдите ваше VPN соединение по его названию, которые вы осмысленно задали в самом начале ;),
- ниже имени будет "id" соединения, его и нужно вписать в строку "eth_id" файла config.ini.


Заполните конфигурационный файл config.ini, указав ВСЕ параметры.

В текстовый файл, указанный вами в config.ini, внесите доменные имена, для которых требуется перенаправление трафика.

Установите на своем роутере или ПК IP адрес машины с запущенным DNS-RouteSync-Navigator в качестве основного DNS сервера.


**Еще:**
- Повышена стабильность работы.
- Добавление маршрута более не блокирует основную функцию DNS сервера.
- Для сокращения числа обращений реализован кэш добавленных ранее IP-адресов. Время жизни 1 час.
- Время жизни DNS кэша 20 секунд.
- Реализован весь задуманный функционал.


#### Протестировано в Windows 11, Ubuntu 20.04/22.04


**От автора:** Скрипт представляет собой логическое продолжение проекта [DomainMapper](https://github.com/Ground-Zerro/DomainMapper). Главной целью является предоставление альтернативы OPKG пакетам на роутерах Keenetic младших моделей, не поддерживающих установку entware.
